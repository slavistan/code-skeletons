#!/usr/bin/env zsh

set -e

[ "$DEBUG" ] && alias logf=printf || logf() {}

usage() {
#TODO(feat): usage
  printf \
    "
"
}

[ "$1" = "-h" ] && usage && exit

# TODO(feat): Make WERKWERKPATH concatenable a la PATH1:PATH2:..
# TODO(fix): Clarify usage and parsing of WERKWERKPATH
if [ ! -d "$WERKWERKPATH" ]; then
  if [ -d /usr/local/share/werkwerk ]; then
    WERKWERKPATH=/usr/local/share/werkwerk;
  elif [ -d /usr/share/werkwerk ]; then
    WERKWERKPATH=/usr/share/werkwerk
  elif [ -d ~/.local/share/werkwerk ]; then
    WERKWERKPATH=~/.local/share/werkwerk
  else
    echo "WERKWERKPATH missing. Abort."
    exit 1
  fi
fi
if [ ! -d "$WERKWERKPATH" ]; then
  # TODO(fix): Clarify usage and parsing of WERKWERKPATH
  echo "\$WERKWERKPATH='$WERKWERKPATH' is not a directory."
  exit 1
fi
logf "WERKWERKPATH=$WERKWERKPATH"

module=$(\
  for subdir in $(find "$WERKWERKPATH" -maxdepth 1 -mindepth 1 -type d -not -name '\.git' -printf '%f\n'); do
    sf="$WERKWERKPATH/$subdir/_setup.sh"
    if [ -f "$sf" ] && grep -q '^# ' "$sf"; then
      printf "$subdir|"
      grep '^# .*$' "$sf" | head -1 | sed -E 's/^# +//g'
    fi
  done | column -t -s '|' | dmenu -l 10 -p "Setup which template?:" | cut -d ' ' -f 1)
[ -z "$module" ] && exit

outdir=$(mktemp -d -t werkwerk-$module-XXXXXX)
logf "outdir = $outdir\n"

# copy template files (omit _setup.sh)
find "$WERKWERKPATH/$module" -mindepth 1 -maxdepth 1 -not -name _setup.sh -exec cp -r {} "$outdir" \;

# workspace setup
cd "$outdir"
"$WERKWERKPATH/$module/_setup.sh"

# TODO(feat): zparseopts for --init-only, --where=...
# TODO(feat): Implement option --list to show all modules and their locations.
#               - Display the optional long discription from the _setup files'
#                 comment block.
# TODO(feat): pandoc md -> options
# TODO(feat): Include setup in compile.sh where possible
